<!doctype html>
<html lang="vi" class="theme-fs-sm" data-bs-theme="light" data-bs-theme-color="default" dir="ltr">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Hóa đơn dịch vụ - KiviCare Clinic</title>
    <meta name="description" content="Hóa đơn dịch vụ y tế">
    <meta name="keywords" content="hóa đơn, dịch vụ, y tế, thanh toán">
    <meta name="author" content="KiviCare">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="../assets/assets/images/favicon.ico" />

    <!-- Library / Plugin Css Build -->
    <link rel="stylesheet" href="../assets/assets/css/core/libs.min.css" />

    <!-- flaticon css -->
    <link rel="stylesheet" href="../assets/assets/vendor/flaticon/css/flaticon.css" />

    <!-- font-awesome css -->
    <link rel="stylesheet" href="../assets/assets/vendor/font-awesome/css/all.min.css" />

    <!-- Flatpickr css -->
    <link rel="stylesheet" href="../assets/assets/vendor/flatpickr/dist/flatpickr.min.css" />

    <link rel="stylesheet" href="../assets/assets/vendor/sheperd/dist/css/sheperd.css">

    <!-- Sweetlaert2 css -->
    <link rel="stylesheet" href="../assets/assets/vendor/sweetalert2/dist/sweetalert2.min.css"/>

    <!-- Kivicare Design System Css -->
    <link rel="stylesheet" href="../assets/assets/css/kivicare.min.css?v=1.4.1" />

    <!-- Custom Css -->
    <link rel="stylesheet" href="../assets/assets/css/custom.min.css?v=1.4.1" />

    <!-- RTL Css -->
    <link rel="stylesheet" href="../assets/assets/css/rtl.min.css?v=1.4.1"/>

    <!-- Customizer Css -->
    <link rel="stylesheet" href="../assets/assets/css/customizer.min.css?v=1.4.1"/>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500&display=swap" rel="stylesheet">
</head>
<body class="full-screen">
    <!-- loader Start -->
    <div id="loading">
        <div class="loader simple-loader">
            <div class="loader-body">
                <img src="../assets/assets/images/loader.gif" alt="loader" class="light-loader img-fluid" width="200">
            </div>
        </div>
    </div>
    <!-- loader END -->
    
    <main class="main-content">
        <div class="position-relative">
            <!--Nav Start-->
            <nav class="nav navbar navbar-expand-xl navbar-light iq-navbar patient-header">
                <div class="container-fluid navbar-inner">
                    <a href="home-patient.html" class="navbar-brand ms-0 me-5">
                        <!--Logo start-->
                        <div class="logo-main">
                            <img class="logo-normal img-fluid" src="../assets/assets/images/logo.png" height="30" alt="logo">
                            <img class="logo-normal dark-normal img-fluid" src="../assets/assets/images/logo-dark.png" height="30" alt="logo">
                            <img class="logo-normal white-normal img-fluid" src="../assets/assets/images/logo-white.png" height="30" alt="logo">
                            <img class="logo-mini img-fluid" src="../assets/assets/images/logo-mini.png" height="30" alt="logo">
                            <img class="logo-mini dark-mini img-fluid" src="../assets/assets/images/logo-mini-dark.png" height="30" alt="logo">
                            <img class="logo-mini white-mini img-fluid" src="../assets/assets/images/logo-mini-white.png" height="30" alt="logo">
                        </div>
                        <!--logo End-->
                    </a>
                    
                    <div class="d-flex align-items-center">
                        <button id="navbar-toggle" class="navbar-toggler px-0" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                            aria-label="Toggle navigation">
                            <span class="navbar-toggler-btn">
                                <span class="navbar-toggler-icon"></span>
                            </span>
                        </button>
                    </div>
                    
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="my-2 navbar-nav ms-auto align-items-center navbar-list">
                            <li class="nav-item">
                                <a href="patient-encounters.html" class="nav-link">
                                    <i class="icon me-2">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </i>
                                    <span>Quay lại</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!--Nav End-->
            
            <!-- Content Start -->
            <div class="content-page">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between">
                                    <div class="header-title">
                                        <h4 class="card-title">Hóa đơn dịch vụ y tế</h4>
                                        <p class="mb-0">Chi tiết các dịch vụ đã sử dụng và thanh toán</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">Tên bệnh nhân</th>
                                                    <th scope="col">Ngày sinh</th>
                                                    <th scope="col">Giới tính</th>
                                                    <th scope="col">Bệnh</th>
                                                    <th scope="col">Kết luận</th>
                                                    <th scope="col">Phác đồ điều trị</th>
                                                    <th scope="col">Tiền dịch vụ</th>
                                                    <th scope="col">Tiền thuốc</th>
                                                    <th scope="col">Tổng tiền</th>
                                                    <th scope="col">Trạng thái</th>
                                                </tr>
                                            </thead>
                                            <tbody id="service-details">
                                                <!-- Dữ liệu dịch vụ sẽ được render ở đây -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-start align-items-center">
                                                <h5 class="mb-0 me-3">Tổng tiền:</h5>
                                                <h4 class="mb-0 text-primary" id="total-amount">0 VNĐ</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-end align-items-center">
                                                <a href="patient-encounters.html" class="btn btn-secondary me-2">
                                                    <i class="fas fa-arrow-left me-1"></i>
                                                    Quay lại
                                                </a>
                                                <button id="pay-btn" class="btn btn-primary" style="display:none;">
                                                    <i class="fas fa-credit-card me-1"></i>
                                                    Thanh toán
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Content End -->
        </div>
    </main>

    <!-- Library Bundle Script -->
    <script src="../assets/assets/js/core/libs.min.js"></script>
    
    <!-- Plugin Scripts -->
    <!-- Sweet-alert Script -->
    <script src="../assets/assets/vendor/sweetalert2/dist/sweetalert2.min.js" async></script>
    <script src="../assets/assets/js/plugins/sweet-alert.js" defer></script>
    
    <!-- Lodash Utility -->
    <script src="../assets/assets/vendor/lodash/lodash.min.js"></script>
    
    <!-- Utilities Functions -->
    <script src="../assets/assets/js/iqonic-script/utility.min.js"></script>
    
    <!-- Settings Script -->
    <script src="../assets/assets/js/iqonic-script/setting.min.js"></script>
    
    <!-- Settings Init Script -->
    <script src="../assets/assets/js/setting-init.js"></script>
    
    <!-- External Library Bundle Script -->
    <script src="../assets/assets/js/core/external.min.js"></script>
    
    <!-- Hopeui Script -->
    <script src="../assets/assets/js/kivicare.js?v=1.4.1" defer></script>
    <script src="../assets/assets/js/kivicare-advance.js?v=1.4.1" defer></script>
    <script src="../assets/assets/js/sidebar.js?v=1.4.1" defer></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patientId');
        
        function renderInvoices(data) {
            console.log('Invoice data received:', data);
            let html = '';
            let totalAmount = 0;
            
            data.forEach(inv => {
                const serviceAmount = parseFloat(inv.serviceAmount) || 0;
                const medicineAmount = parseFloat(inv.medicineAmount) || 0;
                const amount = parseFloat(inv.totalAmount) || 0;
                totalAmount += amount;
                
                html += `<tr>
                    <td>${inv.patientName || 'N/A'}</td>
                    <td>${inv.dob || 'N/A'}</td>
                    <td>${inv.gender || 'N/A'}</td>
                    <td>${inv.disease || 'N/A'}</td>
                    <td>${inv.conclusion || 'N/A'}</td>
                    <td>${inv.treatmentPlan || 'N/A'}</td>
                    <td class="text-end">${formatCurrency(serviceAmount)}</td>
                    <td class="text-end">${formatCurrency(medicineAmount)}</td>
                    <td class="text-end fw-bold">${formatCurrency(amount)}</td>
                    <td>
                        ${inv.status === 'Pending' 
                            ? `<button class="btn btn-success btn-sm pay-btn" data-amount="${amount}" data-invoiceid="${inv.invoiceId}">
                                    <i class="fas fa-credit-card me-1"></i>Thanh toán
                               </button>`
                            : `<span class="badge bg-${inv.status === 'Paid' ? 'success' : 'warning'}">${inv.status}</span>`
                        }
                    </td>
                </tr>`;
            });
            
            document.getElementById('service-details').innerHTML = html;
            document.getElementById('total-amount').textContent = formatCurrency(totalAmount);

            // Gắn sự kiện click cho nút thanh toán
            document.querySelectorAll('.pay-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = this.getAttribute('data-amount');
                    const invoiceId = this.getAttribute('data-invoiceid');
                    console.log('Payment clicked - amount:', amount, 'invoiceId:', invoiceId);
                    
                    // Hiển thị loading
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';
                    this.disabled = true;
                    
                    fetch('/api/vnpay/create-payment', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: `amount=${amount}`
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.paymentUrl) {
                            sessionStorage.setItem('payingInvoiceId', invoiceId);
                            sessionStorage.setItem('payingPatientId', patientId);
                            console.log('Saved to sessionStorage - invoiceId:', invoiceId, 'patientId:', patientId);
                            window.location.href = data.paymentUrl;
                        } else {
                            // Hiển thị lỗi
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi thanh toán',
                                text: 'Không thể tạo liên kết thanh toán. Vui lòng thử lại!'
                            });
                            // Reset button
                            this.innerHTML = '<i class="fas fa-credit-card me-1"></i>Thanh toán';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Payment error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi thanh toán',
                            text: 'Đã xảy ra lỗi khi xử lý thanh toán. Vui lòng thử lại!'
                        });
                        // Reset button
                        this.innerHTML = '<i class="fas fa-credit-card me-1"></i>Thanh toán';
                        this.disabled = false;
                    });
                });
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        if (patientId) {
            // Hiển thị loading
            document.getElementById('service-details').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="spinner-border text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Đang tải dữ liệu...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            fetch(`/invoice?patient_id=${patientId}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return res.json();
                })
                .then(renderInvoices)
                .catch(error => {
                    console.error('Error fetching invoice data:', error);
                    document.getElementById('service-details').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Không thể tải dữ liệu hóa đơn. Vui lòng thử lại!
                            </td>
                        </tr>
                    `;
                });
        } else {
            document.getElementById('service-details').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        Không tìm thấy thông tin bệnh nhân!
                    </td>
                </tr>
            `;
        }
    </script>
</body>
</html> 